var ASG;
(function (ASG) {
    var GalleryViewController = (function () {
        function GalleryViewController(fullscreen, timeout, galleryId) {
            this.fullscreen = fullscreen;
            this.timeout = timeout;
            this.galleryId = galleryId;
            this.help = false;
            this.gui = true;
            this._visible = false;
            this._fullscreen = false;
            this.functionsVisible = false;
            this.transition = 'rotateLR';
            this.transitions = [
                'no',
                'fadeInOut',
                'zoomInOut',
                'rotateLR',
                'rotateTB',
                'rotateZY',
                'slideLR',
                'slideTB',
                'flipX',
                'flipY'
            ];
            if (this.id == undefined) {
                this.id = 'asgid' + this.galleryId.getNext();
            }
        }
        GalleryViewController.prototype.defaults = function () {
            var defaultOptions = {
                baseUrl: "",
                fields: {
                    url: "url",
                    title: "title",
                    description: "description"
                }
            };
            if (this.options == undefined) {
                this.options = defaultOptions;
            }
            else {
                this.options = angular.merge(defaultOptions, this.options);
            }
            if (this.files == undefined) {
                this.files = [];
            }
            if (this.selected == undefined) {
                this.selected = 0;
            }
            console.log(this.options);
        };
        GalleryViewController.prototype.init = function () {
            var self = this;
            this.defaults();
            this.timeout(function () {
                var element = '.gallery-view.' + self.id + ' li.dropdown-submenu';
                angular.element(element).off().on('click', function (event) {
                    event.stopPropagation();
                    if (angular.element(this).hasClass('open')) {
                        angular.element(this).removeClass('open');
                    }
                    else {
                        angular.element(element).removeClass('open');
                        angular.element(this).addClass('open');
                    }
                });
                self.setFocus();
            }, 100);
        };
        GalleryViewController.prototype.preload = function (wait) {
            var _this = this;
            this.timeout(function () {
                _this.loadImage(_this.selected);
                _this.loadImage(0);
                _this.loadImage(_this.selected + 1);
                _this.loadImage(_this.selected - 1);
                _this.loadImage(_this.selected + 2);
                _this.loadImage(_this.files.length - 1);
            }, (wait != undefined) ? wait : 750);
        };
        GalleryViewController.prototype.normalize = function (index) {
            var last = this.files.length - 1;
            if (index > last) {
                return (index - last) - 1;
            }
            if (index < 0) {
                return last - Math.abs(index) + 1;
            }
            return index;
        };
        GalleryViewController.prototype.loadImage = function (index) {
            index = this.normalize(index);
            if (!this.files[index]) {
                console.warn('Invalid file index: ' + index);
                return;
            }
            if (this.files[index].loaded) {
                return;
            }
            var source = this.options.baseUrl + this.files[index][this.options.fields.url];
            var img = new Image();
            img.src = source;
            this.files[index].source = source;
            this.files[index].loaded = true;
            console.log(this.files[index]);
        };
        Object.defineProperty(GalleryViewController.prototype, "visible", {
            get: function () {
                return this._visible;
            },
            set: function (value) {
                this._visible = value;
                if (this._visible) {
                    this.init();
                    this.preload(1);
                    angular.element('body').addClass('yhidden');
                }
                else {
                    angular.element('body').removeClass('yhidden');
                }
            },
            enumerable: true,
            configurable: true
        });
        Object.defineProperty(GalleryViewController.prototype, "isSingle", {
            get: function () {
                return this.files.length > 1 ? false : true;
            },
            enumerable: true,
            configurable: true
        });
        GalleryViewController.prototype.setFocus = function () {
            angular.element('.gallery-view.' + this.id + ' .keyInput').trigger('focus').focus();
        };
        GalleryViewController.prototype.setTransition = function (transition) {
            this.transition = transition;
            this.setFocus();
        };
        GalleryViewController.prototype.functionsHide = function () {
            this.functionsVisible = false;
        };
        GalleryViewController.prototype.functionsShow = function () {
            this.functionsVisible = true;
        };
        GalleryViewController.prototype.downloadLink = function () {
            if (this.selected != undefined) {
                return this.options.baseUrl + this.files[this.selected][this.options.fields.url];
            }
        };
        Object.defineProperty(GalleryViewController.prototype, "file", {
            get: function () {
                return this.files[this.selected];
            },
            enumerable: true,
            configurable: true
        });
        GalleryViewController.prototype.toBackward = function () {
            this.direction = 'backward';
            this.selected = this.normalize(this.selected - 1);
            this.preload();
        };
        GalleryViewController.prototype.toForward = function () {
            this.direction = 'forward';
            this.selected = this.normalize(this.selected + 1);
            this.preload();
        };
        GalleryViewController.prototype.toFirst = function () {
            this.direction = 'backward';
            this.selected = 0;
            this.preload();
        };
        GalleryViewController.prototype.toLast = function () {
            this.direction = 'forward';
            this.selected = this.files.length - 1;
            this.preload();
        };
        GalleryViewController.prototype.exit = function () {
            this.visible = false;
        };
        GalleryViewController.prototype.keyUp = function (e) {
            if (e.keyCode == 27) {
                this.exit();
            }
            if (e.keyCode == 32) {
                this.toForward();
            }
            if (e.keyCode == 37) {
                this.toBackward();
            }
            if (e.keyCode == 39) {
                this.toForward();
            }
            if (e.keyCode == 38 || e.keyCode == 36) {
                this.toFirst();
            }
            if (e.keyCode == 40 || e.keyCode == 35) {
                this.toLast();
            }
            if (e.keyCode == 70 || e.keyCode == 13) {
                this.toggleFullScreen();
            }
            if (e.keyCode == 71) {
                this.toggleGUI();
            }
            if (e.keyCode == 72) {
                this.toggleHelp();
            }
            if (e.keyCode == 84) {
                this.nextTransition();
            }
        };
        GalleryViewController.prototype.nextTransition = function () {
            var idx = this.transitions.indexOf(this.transition) + 1;
            var next = idx >= this.transitions.length ? 0 : idx;
            this.transition = this.transitions[next];
        };
        GalleryViewController.prototype.toggleFullScreen = function () {
            if (this.fullscreen.isEnabled()) {
                this.fullscreen.cancel();
            }
            else {
                this.fullscreen.all();
            }
            this.setFocus();
        };
        GalleryViewController.prototype.toggleHelp = function () {
            this.help = !this.help;
            this.setFocus();
        };
        GalleryViewController.prototype.toggleGUI = function () {
            this.gui = !this.gui;
        };
        return GalleryViewController;
    }());
    ASG.GalleryViewController = GalleryViewController;
    var GalleryIdService = (function () {
        function GalleryIdService() {
            this.id = 1;
        }
        GalleryIdService.prototype.getNext = function () {
            return this.id++;
        };
        return GalleryIdService;
    }());
    ASG.GalleryIdService = GalleryIdService;
    var app = angular.module('angularSuperGallery', ['ngAnimate']);
    app.service('galleryId', GalleryIdService);
    app.component("galleryView", {
        controller: ["Fullscreen", "$timeout", "galleryId", ASG.GalleryViewController],
        templateUrl: 'views/angular-super-gallery.html',
        bindings: {
            visible: '=',
            selected: '<',
            title: '@',
            subtitle: '@',
            files: '=',
            options: '=?'
        }
    });
    app.provider('angularSuperGalleryOptions', function () {
        var defaults = {};
        return {
            setOpts: function (options) {
                angular.extend(defaults, options);
            },
            $get: function () {
                return defaults;
            }
        };
    });
    app.directive('imageOnload', function () {
        return {
            restrict: 'A',
            link: function (scope, element, attrs) {
                element.bind('load', function () {
                    scope.$apply(attrs.imageOnload);
                });
            }
        };
    });
    app.filter('bytes', function () {
        return function (bytes, precision) {
            if (isNaN(parseFloat(bytes)) || !isFinite(bytes))
                return '';
            if (bytes === 0)
                return '0';
            if (typeof precision === 'undefined')
                precision = 1;
            var units = ['bytes', 'kB', 'MB', 'GB', 'TB', 'PB'], number = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, Math.floor(number))).toFixed(precision) + ' ' + units[number];
        };
    });
})(ASG || (ASG = {}));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9hbmd1bGFyLXN1cGVyLWdhbGxlcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsSUFBTyxHQUFHLENBb2NUO0FBcGNELFdBQU8sR0FBRztJQWFOO1FBaUNJLCtCQUFvQixVQUFVLEVBQ1YsT0FBTyxFQUNQLFNBQVM7WUFGVCxlQUFVLEdBQVYsVUFBVSxDQUFBO1lBQ1YsWUFBTyxHQUFQLE9BQU8sQ0FBQTtZQUNQLGNBQVMsR0FBVCxTQUFTLENBQUE7WUExQnRCLFNBQUksR0FBYSxLQUFLLENBQUM7WUFDdkIsUUFBRyxHQUFhLElBQUksQ0FBQztZQUdwQixhQUFRLEdBQWEsS0FBSyxDQUFDO1lBQzNCLGdCQUFXLEdBQWEsS0FBSyxDQUFDO1lBRTlCLHFCQUFnQixHQUFhLEtBQUssQ0FBQztZQUNuQyxlQUFVLEdBQVksVUFBVSxDQUFDO1lBQ2pDLGdCQUFXLEdBQW1CO2dCQUNsQyxJQUFJO2dCQUNKLFdBQVc7Z0JBQ1gsV0FBVztnQkFDWCxVQUFVO2dCQUNWLFVBQVU7Z0JBQ1YsVUFBVTtnQkFDVixTQUFTO2dCQUNULFNBQVM7Z0JBQ1QsT0FBTztnQkFDUCxPQUFPO2FBQ1YsQ0FBQztZQVFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLEVBQUUsR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqRCxDQUFDO1FBRUwsQ0FBQztRQUVPLHdDQUFRLEdBQWhCO1lBRUksSUFBSSxjQUFjLEdBQUc7Z0JBQ2pCLE9BQU8sRUFBRSxFQUFFO2dCQUNYLE1BQU0sRUFBRTtvQkFDSixHQUFHLEVBQUUsS0FBSztvQkFDVixLQUFLLEVBQUUsT0FBTztvQkFDZCxXQUFXLEVBQUUsYUFBYTtpQkFDN0I7YUFDSixDQUFDO1lBRUYsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFD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QUFLLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUMvQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUUxRCxNQUFNLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFakcsQ0FBQyxDQUFBO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFHUCxDQUFDLEVBcGNNLEdBQUcsS0FBSCxHQUFHLFFBb2NUIiwiZmlsZSI6ImFuZ3VsYXItc3VwZXItZ2FsbGVyeS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLzxyZWZlcmVuY2UgcGF0aD1cIi4vLi4vdHlwaW5ncy9pbmRleC5kLnRzXCIgLz5cclxuXHJcbm1vZHVsZSBBU0cge1xyXG5cclxuICAgIGludGVyZmFjZSBJT3B0aW9ucyB7XHJcblxyXG4gICAgICAgIGJhc2VVcmwgOiBzdHJpbmc7XHJcbiAgICAgICAgZmllbGRzIDoge1xyXG4gICAgICAgICAgICB1cmwgOiBzdHJpbmc7XHJcbiAgICAgICAgICAgIHRpdGxlIDogc3RyaW5nO1xyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbiA6IHN0cmluZztcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBjbGFzcyBHYWxsZXJ5Vmlld0NvbnRyb2xsZXIge1xyXG5cclxuICAgICAgICBwdWJsaWMgdGl0bGUgOiBzdHJpbmc7XHJcbiAgICAgICAgcHVibGljIHN1YnRpdGxlIDogc3RyaW5nO1xyXG4gICAgICAgIHB1YmxpYyBmaWxlcyA6IGFueTtcclxuICAgICAgICBwdWJsaWMgc2VsZWN0ZWQgOiBudW1iZXI7XHJcblxyXG4gICAgICAgIHB1YmxpYyBvcHRpb25zIDogSU9wdGlvbnM7XHJcbiAgICAgICAgcHVibGljIGRpcmVjdGlvbiA6IHN0cmluZztcclxuICAgICAgICBwdWJsaWMgaGVscCA6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICBwdWJsaWMgZ3VpIDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAgICAgcHVibGljIGlkIDogc3RyaW5nO1xyXG5cclxuICAgICAgICBwcml2YXRlIF92aXNpYmxlIDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgICAgIHByaXZhdGUgX2Z1bGxzY3JlZW4gOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgICAgIHByaXZhdGUgZnVuY3Rpb25zVmlzaWJsZSA6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgICAgICBwcml2YXRlIHRyYW5zaXRpb24gOiBzdHJpbmcgPSAncm90YXRlTFInO1xyXG4gICAgICAgIHByaXZhdGUgdHJhbnNpdGlvbnMgOiBBcnJheTxzdHJpbmc+ID0gW1xyXG4gICAgICAgICAgICAnbm8nLFxyXG4gICAgICAgICAgICAnZmFkZUluT3V0JyxcclxuICAgICAgICAgICAgJ3pvb21Jbk91dCcsXHJcbiAgICAgICAgICAgICdyb3RhdGVMUicsXHJcbiAgICAgICAgICAgICdyb3RhdGVUQicsXHJcbiAgICAgICAgICAgICdyb3RhdGVaWScsXHJcbiAgICAgICAgICAgICdzbGlkZUxSJyxcclxuICAgICAgICAgICAgJ3NsaWRlVEInLFxyXG4gICAgICAgICAgICAnZmxpcFgnLFxyXG4gICAgICAgICAgICAnZmxpcFknXHJcbiAgICAgICAgXTtcclxuXHJcbiAgICAgICAgLy9wcm90ZWN0ZWQgaW5mb1Zpc2libGUgOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZnVsbHNjcmVlbixcclxuICAgICAgICAgICAgICAgICAgICBwcml2YXRlIHRpbWVvdXQsXHJcbiAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBnYWxsZXJ5SWQpIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlkID09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pZCA9ICdhc2dpZCcgKyB0aGlzLmdhbGxlcnlJZC5nZXROZXh0KCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwcml2YXRlIGRlZmF1bHRzKCkge1xyXG5cclxuICAgICAgICAgICAgdmFyIGRlZmF1bHRPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgYmFzZVVybDogXCJcIixcclxuICAgICAgICAgICAgICAgIGZpZWxkczoge1xyXG4gICAgICAgICAgICAgICAgICAgIHVybDogXCJ1cmxcIixcclxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogXCJ0aXRsZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcImRlc2NyaXB0aW9uXCJcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMgPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMgPSBkZWZhdWx0T3B0aW9ucztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucyA9IGFuZ3VsYXIubWVyZ2UoZGVmYXVsdE9wdGlvbnMsIHRoaXMub3B0aW9ucyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZpbGVzID09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5maWxlcyA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZCA9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSAwO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLm9wdGlvbnMpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAvLyBpbml0aWFsaXplIHRoZSBnYWxsZXJ5XHJcbiAgICAgICAgcHJpdmF0ZSBpbml0KCkge1xyXG5cclxuICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgICAgICB0aGlzLmRlZmF1bHRzKCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoKCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHN1Ym1lbnUgY2xpY2sgZXZlbnRzXHJcbiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9ICcuZ2FsbGVyeS12aWV3LicgKyBzZWxmLmlkICsgJyBsaS5kcm9wZG93bi1zdWJtZW51JztcclxuICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KS5vZmYoKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYW5ndWxhci5lbGVtZW50KHRoaXMpLmhhc0NsYXNzKCdvcGVuJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KHRoaXMpLnJlbW92ZUNsYXNzKCdvcGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpLnJlbW92ZUNsYXNzKCdvcGVuJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCh0aGlzKS5hZGRDbGFzcygnb3BlbicpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHNldCBmb2N1c1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZXRGb2N1cygpO1xyXG5cclxuICAgICAgICAgICAgfSwgMTAwKTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBpbWFnZSBwcmVsb2FkXHJcbiAgICAgICAgcHJpdmF0ZSBwcmVsb2FkKHdhaXQ/IDogbnVtYmVyKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQoKCkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMubG9hZEltYWdlKHRoaXMuc2VsZWN0ZWQpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkSW1hZ2UoMCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLnNlbGVjdGVkICsgMSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLnNlbGVjdGVkIC0gMSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLnNlbGVjdGVkICsgMik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvYWRJbWFnZSh0aGlzLmZpbGVzLmxlbmd0aCAtIDEpO1xyXG5cclxuICAgICAgICAgICAgfSwgKHdhaXQgIT0gdW5kZWZpbmVkKSA/IHdhaXQgOiA3NTApO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyBub3JtYWxpemUoaW5kZXggOiBudW1iZXIpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5maWxlcy5sZW5ndGggLSAxO1xyXG5cclxuICAgICAgICAgICAgaWYgKGluZGV4ID4gbGFzdCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChpbmRleCAtIGxhc3QpIC0gMTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxhc3QgLSBNYXRoLmFicyhpbmRleCkgKyAxO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gaW5kZXg7XHJcblxyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHByaXZhdGUgbG9hZEltYWdlKGluZGV4IDogbnVtYmVyKSB7XHJcblxyXG4gICAgICAgICAgICBpbmRleCA9IHRoaXMubm9ybWFsaXplKGluZGV4KTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5maWxlc1tpbmRleF0pIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignSW52YWxpZCBmaWxlIGluZGV4OiAnICsgaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5maWxlc1tpbmRleF0ubG9hZGVkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLm9wdGlvbnMuYmFzZVVybCArIHRoaXMuZmlsZXNbaW5kZXhdW3RoaXMub3B0aW9ucy5maWVsZHMudXJsXTtcclxuICAgICAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgICAgICBpbWcuc3JjID0gc291cmNlO1xyXG4gICAgICAgICAgICB0aGlzLmZpbGVzW2luZGV4XS5zb3VyY2UgPSBzb3VyY2U7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsZXNbaW5kZXhdLmxvYWRlZCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmZpbGVzW2luZGV4XSk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ2V0IHZpc2libGVcclxuICAgICAgICBwdWJsaWMgZ2V0IHZpc2libGUoKSB7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fdmlzaWJsZTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBzZXQgdmlzaWJsZVxyXG4gICAgICAgIHB1YmxpYyBzZXQgdmlzaWJsZSh2YWx1ZSA6IGJvb2xlYW4pIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuX3Zpc2libGUgPSB2YWx1ZTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLl92aXNpYmxlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnByZWxvYWQoMSk7XHJcbiAgICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoJ2JvZHknKS5hZGRDbGFzcygneWhpZGRlbicpO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgnYm9keScpLnJlbW92ZUNsYXNzKCd5aGlkZGVuJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBpcyBzaW5nbGU/XHJcbiAgICAgICAgcHVibGljIGdldCBpc1NpbmdsZSgpIHtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmZpbGVzLmxlbmd0aCA+IDEgPyBmYWxzZSA6IHRydWU7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gc2V0IHRoZSBmb2N1c1xyXG4gICAgICAgIHB1YmxpYyBzZXRGb2N1cygpIHtcclxuXHJcbiAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudCgnLmdhbGxlcnktdmlldy4nICsgdGhpcy5pZCArICcgLmtleUlucHV0JykudHJpZ2dlcignZm9jdXMnKS5mb2N1cygpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHNldCB0cmFuc2l0aW9uIGVmZmVjdFxyXG4gICAgICAgIHB1YmxpYyBzZXRUcmFuc2l0aW9uKHRyYW5zaXRpb24pIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IHRyYW5zaXRpb247XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Rm9jdXMoKTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBvdmVybGF5IGFycm93cyBoaWRlXHJcbiAgICAgICAgcHVibGljIGZ1bmN0aW9uc0hpZGUoKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9uc1Zpc2libGUgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBvdmVybGF5IGFycm93cyBzaG93XHJcbiAgICAgICAgcHVibGljIGZ1bmN0aW9uc1Nob3coKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9uc1Zpc2libGUgPSB0cnVlO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGdldCB0aGUgZG93bmxvYWQgbGlua1xyXG4gICAgICAgIHB1YmxpYyBkb3dubG9hZExpbmsoKSB7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5zZWxlY3RlZCAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuYmFzZVVybCArIHRoaXMuZmlsZXNbdGhpcy5zZWxlY3RlZF1bdGhpcy5vcHRpb25zLmZpZWxkcy51cmxdO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ2V0IHRoZSBmaWxlXHJcbiAgICAgICAgcHVibGljIGdldCBmaWxlKCkge1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmlsZXNbdGhpcy5zZWxlY3RlZF07XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ28gdG8gYmFja3dhcmRcclxuICAgICAgICBwdWJsaWMgdG9CYWNrd2FyZCgpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ2JhY2t3YXJkJztcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRoaXMubm9ybWFsaXplKHRoaXMuc2VsZWN0ZWQgLSAxKTtcclxuICAgICAgICAgICAgdGhpcy5wcmVsb2FkKCk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ28gdG8gZm9yd2FyZFxyXG4gICAgICAgIHB1YmxpYyB0b0ZvcndhcmQoKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRpcmVjdGlvbiA9ICdmb3J3YXJkJztcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHRoaXMubm9ybWFsaXplKHRoaXMuc2VsZWN0ZWQgKyAxKTtcclxuICAgICAgICAgICAgdGhpcy5wcmVsb2FkKCk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gZ28gdG8gZmlyc3RcclxuICAgICAgICBwdWJsaWMgdG9GaXJzdCgpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ2JhY2t3YXJkJztcclxuICAgICAgICAgICAgdGhpcy5zZWxlY3RlZCA9IDA7XHJcbiAgICAgICAgICAgIHRoaXMucHJlbG9hZCgpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGdvIHRvIGxhc3RcclxuICAgICAgICBwdWJsaWMgdG9MYXN0KCkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSAnZm9yd2FyZCc7XHJcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0aGlzLmZpbGVzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgICAgIHRoaXMucHJlbG9hZCgpO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGV4aXRcclxuICAgICAgICBwdWJsaWMgZXhpdCgpIHtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlO1xyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGtleW1hcFxyXG4gICAgICAgIHB1YmxpYyBrZXlVcChlKSB7XHJcblxyXG4gICAgICAgICAgICAvLyBlc2NcclxuICAgICAgICAgICAgaWYgKGUua2V5Q29kZSA9PSAyNykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5leGl0KCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIHNwYWNlXHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMzIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9Gb3J3YXJkKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGxlZnRcclxuICAgICAgICAgICAgaWYgKGUua2V5Q29kZSA9PSAzNykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50b0JhY2t3YXJkKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIHJpZ2h0XHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMzkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9Gb3J3YXJkKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIHVwXHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gMzggfHwgZS5rZXlDb2RlID09IDM2KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnRvRmlyc3QoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZG93blxyXG4gICAgICAgICAgICBpZiAoZS5rZXlDb2RlID09IDQwIHx8IGUua2V5Q29kZSA9PSAzNSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50b0xhc3QoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gZiAtIGZ1bGxzY3JlZW5cclxuICAgICAgICAgICAgaWYgKGUua2V5Q29kZSA9PSA3MCB8fCBlLmtleUNvZGUgPT0gMTMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlRnVsbFNjcmVlbigpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBnIC0gZ3VpXHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gNzEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlR1VJKCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGggLSBoZWxwXHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gNzIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlSGVscCgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyB0IC0gdHJhbnNpdGlvbiBuZXh0XHJcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT0gODQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubmV4dFRyYW5zaXRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHN3aXRjaCB0byBuZXh0IHRyYW5zaXRpb24gZWZmZWN0XHJcbiAgICAgICAgcHJpdmF0ZSBuZXh0VHJhbnNpdGlvbigpIHtcclxuXHJcbiAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLnRyYW5zaXRpb25zLmluZGV4T2YodGhpcy50cmFuc2l0aW9uKSArIDE7XHJcbiAgICAgICAgICAgIHZhciBuZXh0ID0gaWR4ID49IHRoaXMudHJhbnNpdGlvbnMubGVuZ3RoID8gMCA6IGlkeDtcclxuICAgICAgICAgICAgdGhpcy50cmFuc2l0aW9uID0gdGhpcy50cmFuc2l0aW9uc1tuZXh0XTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0b2dnbGUgZnVsbHNjcmVlblxyXG4gICAgICAgIHByaXZhdGUgdG9nZ2xlRnVsbFNjcmVlbigpIHtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZ1bGxzY3JlZW4uaXNFbmFibGVkKCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVsbHNjcmVlbi5jYW5jZWwoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVsbHNjcmVlbi5hbGwoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldEZvY3VzKCk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdG9nZ2xlIGhlbHBcclxuICAgICAgICBwcml2YXRlIHRvZ2dsZUhlbHAoKSB7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmhlbHAgPSAhdGhpcy5oZWxwO1xyXG4gICAgICAgICAgICB0aGlzLnNldEZvY3VzKCk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gdG9nZ2xlIEdVSVxyXG4gICAgICAgIHByaXZhdGUgdG9nZ2xlR1VJKCkge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ndWkgPSAhdGhpcy5ndWk7XHJcblxyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgLy8gZ2FsbGVyeSB1bmlxdWUgaWQgc2VydmljZVxyXG4gICAgZXhwb3J0IGNsYXNzIEdhbGxlcnlJZFNlcnZpY2Uge1xyXG5cclxuICAgICAgICBwcml2YXRlIGlkID0gMTtcclxuXHJcbiAgICAgICAgcHVibGljIGdldE5leHQoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmlkKys7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcblxyXG4gICAgdmFyIGFwcCA6IG5nLklNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnYW5ndWxhclN1cGVyR2FsbGVyeScsIFsnbmdBbmltYXRlJ10pO1xyXG5cclxuICAgIGFwcC5zZXJ2aWNlKCdnYWxsZXJ5SWQnLCBHYWxsZXJ5SWRTZXJ2aWNlKTtcclxuXHJcbiAgICBhcHAuY29tcG9uZW50KFwiZ2FsbGVyeVZpZXdcIiwge1xyXG4gICAgICAgIGNvbnRyb2xsZXI6IFtcIkZ1bGxzY3JlZW5cIiwgXCIkdGltZW91dFwiLCBcImdhbGxlcnlJZFwiLCBBU0cuR2FsbGVyeVZpZXdDb250cm9sbGVyXSxcclxuICAgICAgICB0ZW1wbGF0ZVVybDogJ3ZpZXdzL2FuZ3VsYXItc3VwZXItZ2FsbGVyeS5odG1sJyxcclxuICAgICAgICBiaW5kaW5nczoge1xyXG4gICAgICAgICAgICB2aXNpYmxlOiAnPScsXHJcbiAgICAgICAgICAgIHNlbGVjdGVkOiAnPCcsXHJcbiAgICAgICAgICAgIHRpdGxlOiAnQCcsXHJcbiAgICAgICAgICAgIHN1YnRpdGxlOiAnQCcsXHJcbiAgICAgICAgICAgIGZpbGVzOiAnPScsXHJcbiAgICAgICAgICAgIG9wdGlvbnM6ICc9PydcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBhcHAucHJvdmlkZXIoJ2FuZ3VsYXJTdXBlckdhbGxlcnlPcHRpb25zJywgZnVuY3Rpb24gKCkge1xyXG5cclxuICAgICAgICB2YXIgZGVmYXVsdHMgPSB7fTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgc2V0T3B0czogZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKGRlZmF1bHRzLCBvcHRpb25zKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgJGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIGFwcC5kaXJlY3RpdmUoJ2ltYWdlT25sb2FkJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsXHJcbiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cnMgOiBhbnkpIHtcclxuICAgICAgICAgICAgICAgIGVsZW1lbnQuYmluZCgnbG9hZCcsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoYXR0cnMuaW1hZ2VPbmxvYWQpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgfSk7XHJcblxyXG4gICAgYXBwLmZpbHRlcignYnl0ZXMnLCAoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChieXRlcyA6IGFueSwgcHJlY2lzaW9uIDogbnVtYmVyKSA6IHN0cmluZyB7XHJcblxyXG4gICAgICAgICAgICBpZiAoaXNOYU4ocGFyc2VGbG9hdChieXRlcykpIHx8ICFpc0Zpbml0ZShieXRlcykpIHJldHVybiAnJ1xyXG4gICAgICAgICAgICBpZiAoYnl0ZXMgPT09IDApIHJldHVybiAnMCc7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJlY2lzaW9uID09PSAndW5kZWZpbmVkJykgcHJlY2lzaW9uID0gMTtcclxuXHJcbiAgICAgICAgICAgIHZhciB1bml0cyA9IFsnYnl0ZXMnLCAna0InLCAnTUInLCAnR0InLCAnVEInLCAnUEInXSxcclxuICAgICAgICAgICAgICAgIG51bWJlciA9IE1hdGguZmxvb3IoTWF0aC5sb2coYnl0ZXMpIC8gTWF0aC5sb2coMTAyNCkpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIChieXRlcyAvIE1hdGgucG93KDEwMjQsIE1hdGguZmxvb3IobnVtYmVyKSkpLnRvRml4ZWQocHJlY2lzaW9uKSArICcgJyArIHVuaXRzW251bWJlcl07XHJcblxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuXHJcbn1cclxuXHJcbiJdfQ==
